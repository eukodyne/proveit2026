FROM nvcr.io/nvidia/vllm:25.12-py3

USER root
# Install every possible build requirement for vLLM 0.13
RUN apt-get update && apt-get install -y python3.12-dev cmake git ccache ninja-build && \
    pip install uv --break-system-packages && \
    uv pip install --system --break-system-packages "setuptools>=69.0" "setuptools_scm>=8.0" "wheel" "ninja"

# Single-step clone and install
RUN git clone --depth 1 --branch v0.13.0 https://github.com/vllm-project/vllm.git /opt/vllm_src && \
    cd /opt/vllm_src && \
    uv pip install --system --break-system-packages \
    "ijson" "partial-json-parser" "py-cpuinfo" "xgrammar" "flashinfer-python" && \
    VLLM_TARGET_DEVICE=cuda python3 setup.py install

ENTRYPOINT ["python3", "-m", "vllm.entrypoints.openai.api_server"]